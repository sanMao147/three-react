import{e,c as t,f as n,i as r,j as i,b as a,k as s,l as o,a as u,m as l,_ as c,h as d,g as f,d as g}from"./@babel-ebff8eee.js";import{a as v,m as h,n as m,t as p}from"./rc-util-1ed7d15f.js";import{S as F}from"./async-validator-455bc203.js";var y="RC_FORM_INTERNAL_HOOKS",V=function(){v(!1,"Can not find FormContext. Please make sure you wrap Field under Form.")},b=React.createContext({getFieldValue:V,getFieldsValue:V,getFieldError:V,getFieldWarning:V,getFieldsError:V,isFieldsTouched:V,isFieldTouched:V,isFieldValidating:V,isFieldsValidating:V,resetFields:V,setFields:V,setFieldValue:V,setFieldsValue:V,validateFields:V,submit:V,getInternalHooks:function(){return V(),{dispatch:V,initEntityValue:V,registerField:V,useSubscribe:V,setInitialValues:V,destroyForm:V,setCallbacks:V,registerWatch:V,getFields:V,setValidateMessages:V,setPreserve:V,getInitialValue:V}}});function E(e){return null==e?[]:Array.isArray(e)?e:[e]}var k="'${name}' is not a valid ${type}",P={default:"Validation error on field '${name}'",required:"'${name}' is required",enum:"'${name}' must be one of [${enum}]",whitespace:"'${name}' cannot be empty",date:{format:"'${name}' is invalid for format date",parse:"'${name}' could not be parsed as date",invalid:"'${name}' is invalid date"},types:{string:k,method:k,array:k,object:k,number:k,date:k,boolean:k,integer:k,float:k,regexp:k,email:k,url:k,hex:k},string:{len:"'${name}' must be exactly ${len} characters",min:"'${name}' must be at least ${min} characters",max:"'${name}' cannot be longer than ${max} characters",range:"'${name}' must be between ${min} and ${max} characters"},number:{len:"'${name}' must equal ${len}",min:"'${name}' cannot be less than ${min}",max:"'${name}' cannot be greater than ${max}",range:"'${name}' must be between ${min} and ${max}"},array:{len:"'${name}' must be exactly ${len} in length",min:"'${name}' cannot be less than ${min} in length",max:"'${name}' cannot be greater than ${max} in length",range:"'${name}' must be between ${min} and ${max} in length"},pattern:{mismatch:"'${name}' does not match pattern ${pattern}"}};function w(t){return Array.isArray(t)?t.map((function(e){return w(e)})):"object"===e(t)&&null!==t?function(e){if(Object.getPrototypeOf(e)===Object.prototype){var t={};for(var n in e)t[n]=w(e[n]);return t}return e}(t):t}function R(e){return E(e)}function C(e,t){return h(e,t)}function x(e,t,n){return m(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3])}function N(e,t){var n={};return t.forEach((function(t){var r=C(e,t);n=x(n,t,r)})),n}function M(e,t){return e&&e.some((function(e){return A(e,t)}))}function I(t){return"object"===e(t)&&null!==t&&Object.getPrototypeOf(t)===Object.prototype}function $(e,r){var i=Array.isArray(e)?t(e):n({},e);return r?(Object.keys(r).forEach((function(e){var t=i[e],n=r[e],a=I(t)&&I(n);i[e]=a?$(t,n||{}):w(n)})),i):i}function O(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reduce((function(e,t){return $(e,t)}),e)}function A(e,t){return!(!e||!t||e.length!==t.length)&&e.every((function(e,n){return t[n]===e}))}function S(t){var n=arguments.length<=1?void 0:arguments[1];return n&&n.target&&"object"===e(n.target)&&t in n.target?n.target[t]:n}function U(e,n,r){var i=e.length;if(n<0||n>=i||r<0||r>=i)return e;var a=e[n],s=n-r;return s>0?[].concat(t(e.slice(0,r)),[a],t(e.slice(r,n)),t(e.slice(n+1,i))):s<0?[].concat(t(e.slice(0,n)),t(e.slice(n+1,r+1)),[a],t(e.slice(r+1,i))):e}var j=F;function T(e,t){return e.replace(/\$\{\w+\}/g,(function(e){var n=e.slice(2,-1);return t[n]}))}var L="CODE_LOGIC_ERROR";function W(e,t,n,r,i){return _.apply(this,arguments)}function _(){return _=r(i().mark((function e(r,s,o,u,l){var c,d,f,g,v,h,m,p,F;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return delete(c=n({},o)).ruleIndex,c.validator&&(d=c.validator,c.validator=function(){try{return d.apply(void 0,arguments)}catch(e){return Promise.reject(L)}}),f=null,c&&"array"===c.type&&c.defaultField&&(f=c.defaultField,delete c.defaultField),g=new j(a({},r,[c])),v=O({},P,u.validateMessages),g.messages(v),h=[],e.prev=9,e.next=12,Promise.resolve(g.validate(a({},r,s),n({},u)));case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(9),e.t0.errors&&(h=e.t0.errors.map((function(e,t){var n=e.message,r=n===L?v.default:n;return React.isValidElement(r)?React.cloneElement(r,{key:"error_".concat(t)}):r})));case 17:if(h.length||!f){e.next=22;break}return e.next=20,Promise.all(s.map((function(e,t){return W("".concat(r,".").concat(t),e,f,u,l)})));case 20:return m=e.sent,e.abrupt("return",m.reduce((function(e,n){return[].concat(t(e),t(n))}),[]));case 22:return p=n(n({},o),{},{name:r,enum:(o.enum||[]).join(", ")},l),F=h.map((function(e){return"string"==typeof e?T(e,p):e})),e.abrupt("return",F);case 25:case"end":return e.stop()}}),e,null,[[9,14]])}))),_.apply(this,arguments)}function H(e,t,a,s,o,u){var l,c,d=e.join("."),f=a.map((function(e,t){var r=e.validator,i=n(n({},e),{},{ruleIndex:t});return r&&(i.validator=function(e,t,n){var i=!1,a=r(e,t,(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];Promise.resolve().then((function(){v(!i,"Your validator function has already return a promise. `callback` will be ignored."),i||n.apply(void 0,t)}))}));i=a&&"function"==typeof a.then&&"function"==typeof a.catch,v(i,"`callback` is deprecated. Please return a promise instead."),i&&a.then((function(){n()})).catch((function(e){n(e||" ")}))}),i})).sort((function(e,t){var n=e.warningOnly,r=e.ruleIndex,i=t.warningOnly,a=t.ruleIndex;return!!n==!!i?r-a:n?1:-1}));if(!0===o)l=new Promise((c=r(i().mark((function e(n,r){var a,o,l;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=0;case 1:if(!(a<f.length)){e.next=12;break}return o=f[a],e.next=5,W(d,t,o,s,u);case 5:if(!(l=e.sent).length){e.next=9;break}return r([{errors:l,rule:o}]),e.abrupt("return");case 9:a+=1,e.next=1;break;case 12:n([]);case 13:case"end":return e.stop()}}),e)}))),function(e,t){return c.apply(this,arguments)}));else{var g=f.map((function(e){return W(d,t,e,s,u).then((function(t){return{errors:t,rule:e}}))}));l=(o?function(e){return q.apply(this,arguments)}(g):function(e){return D.apply(this,arguments)}(g)).then((function(e){return Promise.reject(e)}))}return l.catch((function(e){return e})),l}function D(){return(D=r(i().mark((function e(n){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all(n).then((function(e){var n;return(n=[]).concat.apply(n,t(e))})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function q(){return(q=r(i().mark((function e(t){var n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=0,e.abrupt("return",new Promise((function(e){t.forEach((function(r){r.then((function(r){r.errors.length&&e([r]),(n+=1)===t.length&&e([])}))}))})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var z=["name"],J=[];function K(e,t,n,r,i,a){return"function"==typeof e?e(t,n,"source"in a?{source:a.source}:{}):r!==i}var B=function(e){s(i,e);var r=o(i);function i(e){var s;return u(this,i),(s=r.call(this,e)).state={resetCount:0},s.cancelRegisterFunc=null,s.mounted=!1,s.touched=!1,s.dirty=!1,s.validatePromise=void 0,s.prevValidating=void 0,s.errors=J,s.warnings=J,s.cancelRegister=function(){var e=s.props,t=e.preserve,n=e.isListField,r=e.name;s.cancelRegisterFunc&&s.cancelRegisterFunc(n,t,R(r)),s.cancelRegisterFunc=null},s.getNamePath=function(){var e=s.props,n=e.name,r=e.fieldContext.prefixName;return void 0!==n?[].concat(t(void 0===r?[]:r),t(n)):[]},s.getRules=function(){var e=s.props,t=e.rules,n=void 0===t?[]:t,r=e.fieldContext;return n.map((function(e){return"function"==typeof e?e(r):e}))},s.refresh=function(){s.mounted&&s.setState((function(e){return{resetCount:e.resetCount+1}}))},s.triggerMetaEvent=function(e){var t=s.props.onMetaChange;null==t||t(n(n({},s.getMeta()),{},{destroy:e}))},s.onStoreChange=function(e,t,n){var r=s.props,i=r.shouldUpdate,a=r.dependencies,o=void 0===a?[]:a,u=r.onReset,l=n.store,c=s.getNamePath(),d=s.getValue(e),f=s.getValue(l),g=t&&M(t,c);switch("valueUpdate"===n.type&&"external"===n.source&&d!==f&&(s.touched=!0,s.dirty=!0,s.validatePromise=null,s.errors=J,s.warnings=J,s.triggerMetaEvent()),n.type){case"reset":if(!t||g)return s.touched=!1,s.dirty=!1,s.validatePromise=null,s.errors=J,s.warnings=J,s.triggerMetaEvent(),null==u||u(),void s.refresh();break;case"remove":if(i)return void s.reRender();break;case"setField":if(g){var v=n.data;return"touched"in v&&(s.touched=v.touched),"validating"in v&&!("originRCField"in v)&&(s.validatePromise=v.validating?Promise.resolve([]):null),"errors"in v&&(s.errors=v.errors||J),"warnings"in v&&(s.warnings=v.warnings||J),s.dirty=!0,s.triggerMetaEvent(),void s.reRender()}if(i&&!c.length&&K(i,e,l,d,f,n))return void s.reRender();break;case"dependenciesUpdate":if(o.map(R).some((function(e){return M(n.relatedFields,e)})))return void s.reRender();break;default:if(g||(!o.length||c.length||i)&&K(i,e,l,d,f,n))return void s.reRender()}!0===i&&s.reRender()},s.validateRules=function(e){var n=s.getNamePath(),r=s.getValue(),i=Promise.resolve().then((function(){if(!s.mounted)return[];var a=s.props,o=a.validateFirst,u=void 0!==o&&o,l=a.messageVariables,c=(e||{}).triggerName,d=s.getRules();c&&(d=d.filter((function(e){return e})).filter((function(e){var t=e.validateTrigger;return!t||E(t).includes(c)})));var f=H(n,r,d,e,u,l);return f.catch((function(e){return e})).then((function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:J;if(s.validatePromise===i){var n;s.validatePromise=null;var r=[],a=[];null===(n=e.forEach)||void 0===n||n.call(e,(function(e){var n=e.rule.warningOnly,i=e.errors,s=void 0===i?J:i;n?a.push.apply(a,t(s)):r.push.apply(r,t(s))})),s.errors=r,s.warnings=a,s.triggerMetaEvent(),s.reRender()}})),f}));return s.validatePromise=i,s.dirty=!0,s.errors=J,s.warnings=J,s.triggerMetaEvent(),s.reRender(),i},s.isFieldValidating=function(){return!!s.validatePromise},s.isFieldTouched=function(){return s.touched},s.isFieldDirty=function(){return!(!s.dirty&&void 0===s.props.initialValue)||void 0!==(0,s.props.fieldContext.getInternalHooks(y).getInitialValue)(s.getNamePath())},s.getErrors=function(){return s.errors},s.getWarnings=function(){return s.warnings},s.isListField=function(){return s.props.isListField},s.isList=function(){return s.props.isList},s.isPreserve=function(){return s.props.preserve},s.getMeta=function(){return s.prevValidating=s.isFieldValidating(),{touched:s.isFieldTouched(),validating:s.prevValidating,errors:s.errors,warnings:s.warnings,name:s.getNamePath(),validated:null===s.validatePromise}},s.getOnlyChild=function(e){if("function"==typeof e){var t=s.getMeta();return n(n({},s.getOnlyChild(e(s.getControlled(),t,s.props.fieldContext))),{},{isFunction:!0})}var r=p(e);return 1===r.length&&React.isValidElement(r[0])?{child:r[0],isFunction:!1}:{child:r,isFunction:!1}},s.getValue=function(e){var t=s.props.fieldContext.getFieldsValue,n=s.getNamePath();return C(e||t(!0),n)},s.getControlled=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=s.props,r=t.trigger,i=t.validateTrigger,o=t.getValueFromEvent,u=t.normalize,l=t.valuePropName,c=t.getValueProps,d=t.fieldContext,f=void 0!==i?i:d.validateTrigger,g=s.getNamePath(),v=d.getInternalHooks,h=d.getFieldsValue,m=v(y).dispatch,p=s.getValue(),F=c||function(e){return a({},l,e)},V=e[r],b=n(n({},e),F(p));return b[r]=function(){var e;s.touched=!0,s.dirty=!0,s.triggerMetaEvent();for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];e=o?o.apply(void 0,n):S.apply(void 0,[l].concat(n)),u&&(e=u(e,p,h(!0))),m({type:"updateValue",namePath:g,value:e}),V&&V.apply(void 0,n)},E(f||[]).forEach((function(e){var t=b[e];b[e]=function(){t&&t.apply(void 0,arguments);var n=s.props.rules;n&&n.length&&m({type:"validateField",namePath:g,triggerName:e})}})),b},e.fieldContext&&(0,(0,e.fieldContext.getInternalHooks)(y).initEntityValue)(l(s)),s}return c(i,[{key:"componentDidMount",value:function(){var e=this.props,t=e.shouldUpdate,n=e.fieldContext;if(this.mounted=!0,n){var r=(0,n.getInternalHooks)(y).registerField;this.cancelRegisterFunc=r(this)}!0===t&&this.reRender()}},{key:"componentWillUnmount",value:function(){this.cancelRegister(),this.triggerMetaEvent(!0),this.mounted=!1}},{key:"reRender",value:function(){this.mounted&&this.forceUpdate()}},{key:"render",value:function(){var e,t=this.state.resetCount,n=this.props.children,r=this.getOnlyChild(n),i=r.child;return r.isFunction?e=i:React.isValidElement(i)?e=React.cloneElement(i,this.getControlled(i.props)):(v(!i,"`children` of Field is not validate ReactElement."),e=i),React.createElement(React.Fragment,{key:t},e)}}]),i}(React.Component);function G(e){var t=e.name,n=d(e,z),r=React.useContext(b),i=void 0!==t?R(t):void 0,a="keep";return n.isListField||(a="_".concat((i||[]).join("_"))),React.createElement(B,f({key:a,name:i},n,{fieldContext:r}))}B.contextType=b,B.defaultProps={trigger:"onChange",valuePropName:"value"};var Y=React.createContext(null),Q="__@field_split__";function X(t){return t.map((function(t){return"".concat(e(t),":").concat(t)})).join(Q)}var Z=function(){function e(){u(this,e),this.kvs=new Map}return c(e,[{key:"set",value:function(e,t){this.kvs.set(X(e),t)}},{key:"get",value:function(e){return this.kvs.get(X(e))}},{key:"update",value:function(e,t){var n=t(this.get(e));n?this.set(e,n):this.delete(e)}},{key:"delete",value:function(e){this.kvs.delete(X(e))}},{key:"map",value:function(e){return t(this.kvs.entries()).map((function(t){var n=g(t,2),r=n[0],i=n[1],a=r.split(Q);return e({key:a.map((function(e){var t=e.match(/^([^:]*):(.*)$/),n=g(t,3),r=n[1],i=n[2];return"number"===r?Number(i):i})),value:i})}))}},{key:"toJSON",value:function(){var e={};return this.map((function(t){var n=t.key,r=t.value;return e[n.join(".")]=r,null})),e}}]),e}(),ee=["name","errors"],te=c((function e(r){var i=this;u(this,e),this.formHooked=!1,this.forceRootUpdate=void 0,this.subscribable=!0,this.store={},this.fieldEntities=[],this.initialValues={},this.callbacks={},this.validateMessages=null,this.preserve=null,this.lastValidatePromise=null,this.getForm=function(){return{getFieldValue:i.getFieldValue,getFieldsValue:i.getFieldsValue,getFieldError:i.getFieldError,getFieldWarning:i.getFieldWarning,getFieldsError:i.getFieldsError,isFieldsTouched:i.isFieldsTouched,isFieldTouched:i.isFieldTouched,isFieldValidating:i.isFieldValidating,isFieldsValidating:i.isFieldsValidating,resetFields:i.resetFields,setFields:i.setFields,setFieldValue:i.setFieldValue,setFieldsValue:i.setFieldsValue,validateFields:i.validateFields,submit:i.submit,_init:!0,getInternalHooks:i.getInternalHooks}},this.getInternalHooks=function(e){return e===y?(i.formHooked=!0,{dispatch:i.dispatch,initEntityValue:i.initEntityValue,registerField:i.registerField,useSubscribe:i.useSubscribe,setInitialValues:i.setInitialValues,destroyForm:i.destroyForm,setCallbacks:i.setCallbacks,setValidateMessages:i.setValidateMessages,getFields:i.getFields,setPreserve:i.setPreserve,getInitialValue:i.getInitialValue,registerWatch:i.registerWatch}):(v(!1,"`getInternalHooks` is internal usage. Should not call directly."),null)},this.useSubscribe=function(e){i.subscribable=e},this.prevWithoutPreserves=null,this.setInitialValues=function(e,t){if(i.initialValues=e||{},t){var n,r=O({},e,i.store);null===(n=i.prevWithoutPreserves)||void 0===n||n.map((function(t){var n=t.key;r=x(r,n,C(e,n))})),i.prevWithoutPreserves=null,i.updateStore(r)}},this.destroyForm=function(){var e=new Z;i.getFieldEntities(!0).forEach((function(t){i.isMergedPreserve(t.isPreserve())||e.set(t.getNamePath(),!0)})),i.prevWithoutPreserves=e},this.getInitialValue=function(e){var t=C(i.initialValues,e);return e.length?w(t):t},this.setCallbacks=function(e){i.callbacks=e},this.setValidateMessages=function(e){i.validateMessages=e},this.setPreserve=function(e){i.preserve=e},this.watchList=[],this.registerWatch=function(e){return i.watchList.push(e),function(){i.watchList=i.watchList.filter((function(t){return t!==e}))}},this.notifyWatch=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(i.watchList.length){var t=i.getFieldsValue();i.watchList.forEach((function(n){n(t,e)}))}},this.timeoutId=null,this.warningUnhooked=function(){},this.updateStore=function(e){i.store=e},this.getFieldEntities=function(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?i.fieldEntities.filter((function(e){return e.getNamePath().length})):i.fieldEntities},this.getFieldsMap=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=new Z;return i.getFieldEntities(e).forEach((function(e){var n=e.getNamePath();t.set(n,e)})),t},this.getFieldEntitiesForNamePathList=function(e){if(!e)return i.getFieldEntities(!0);var t=i.getFieldsMap(!0);return e.map((function(e){var n=R(e);return t.get(n)||{INVALIDATE_NAME_PATH:R(e)}}))},this.getFieldsValue=function(e,t){if(i.warningUnhooked(),!0===e&&!t)return i.store;var n=i.getFieldEntitiesForNamePathList(Array.isArray(e)?e:null),r=[];return n.forEach((function(n){var i,a="INVALIDATE_NAME_PATH"in n?n.INVALIDATE_NAME_PATH:n.getNamePath();if(e||!(null===(i=n.isListField)||void 0===i?void 0:i.call(n)))if(t){var s="getMeta"in n?n.getMeta():null;t(s)&&r.push(a)}else r.push(a)})),N(i.store,r.map(R))},this.getFieldValue=function(e){i.warningUnhooked();var t=R(e);return C(i.store,t)},this.getFieldsError=function(e){return i.warningUnhooked(),i.getFieldEntitiesForNamePathList(e).map((function(t,n){return t&&!("INVALIDATE_NAME_PATH"in t)?{name:t.getNamePath(),errors:t.getErrors(),warnings:t.getWarnings()}:{name:R(e[n]),errors:[],warnings:[]}}))},this.getFieldError=function(e){i.warningUnhooked();var t=R(e);return i.getFieldsError([t])[0].errors},this.getFieldWarning=function(e){i.warningUnhooked();var t=R(e);return i.getFieldsError([t])[0].warnings},this.isFieldsTouched=function(){i.warningUnhooked();for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];var a,s=n[0],o=n[1],u=!1;0===n.length?a=null:1===n.length?Array.isArray(s)?(a=s.map(R),u=!1):(a=null,u=s):(a=s.map(R),u=o);var l=i.getFieldEntities(!0),c=function(e){return e.isFieldTouched()};if(!a)return u?l.every(c):l.some(c);var d=new Z;a.forEach((function(e){d.set(e,[])})),l.forEach((function(e){var n=e.getNamePath();a.forEach((function(r){r.every((function(e,t){return n[t]===e}))&&d.update(r,(function(n){return[].concat(t(n),[e])}))}))}));var f=function(e){return e.some(c)},g=d.map((function(e){return e.value}));return u?g.every(f):g.some(f)},this.isFieldTouched=function(e){return i.warningUnhooked(),i.isFieldsTouched([e])},this.isFieldsValidating=function(e){i.warningUnhooked();var t=i.getFieldEntities();if(!e)return t.some((function(e){return e.isFieldValidating()}));var n=e.map(R);return t.some((function(e){var t=e.getNamePath();return M(n,t)&&e.isFieldValidating()}))},this.isFieldValidating=function(e){return i.warningUnhooked(),i.isFieldsValidating([e])},this.resetWithFieldInitialValue=function(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=new Z,a=i.getFieldEntities(!0);a.forEach((function(e){var t=e.props.initialValue,n=e.getNamePath();if(void 0!==t){var i=r.get(n)||new Set;i.add({entity:e,value:t}),r.set(n,i)}})),n.entities?e=n.entities:n.namePathList?(e=[],n.namePathList.forEach((function(n){var i,a=r.get(n);a&&(i=e).push.apply(i,t(t(a).map((function(e){return e.entity}))))}))):e=a,e.forEach((function(e){if(void 0!==e.props.initialValue){var a=e.getNamePath();if(void 0!==i.getInitialValue(a))v(!1,"Form already set 'initialValues' with path '".concat(a.join("."),"'. Field can not overwrite it."));else{var s=r.get(a);if(s&&s.size>1)v(!1,"Multiple Field with path '".concat(a.join("."),"' set 'initialValue'. Can not decide which one to pick."));else if(s){var o=i.getFieldValue(a);n.skipExist&&void 0!==o||i.updateStore(x(i.store,a,t(s)[0].value))}}}}))},this.resetFields=function(e){i.warningUnhooked();var t=i.store;if(!e)return i.updateStore(O({},i.initialValues)),i.resetWithFieldInitialValue(),i.notifyObservers(t,null,{type:"reset"}),void i.notifyWatch();var n=e.map(R);n.forEach((function(e){var t=i.getInitialValue(e);i.updateStore(x(i.store,e,t))})),i.resetWithFieldInitialValue({namePathList:n}),i.notifyObservers(t,n,{type:"reset"}),i.notifyWatch(n)},this.setFields=function(e){i.warningUnhooked();var t=i.store,n=[];e.forEach((function(e){var r=e.name;e.errors;var a=d(e,ee),s=R(r);n.push(s),"value"in a&&i.updateStore(x(i.store,s,a.value)),i.notifyObservers(t,[s],{type:"setField",data:e})})),i.notifyWatch(n)},this.getFields=function(){return i.getFieldEntities(!0).map((function(e){var t=e.getNamePath(),r=e.getMeta(),a=n(n({},r),{},{name:t,value:i.getFieldValue(t)});return Object.defineProperty(a,"originRCField",{value:!0}),a}))},this.initEntityValue=function(e){var t=e.props.initialValue;if(void 0!==t){var n=e.getNamePath();void 0===C(i.store,n)&&i.updateStore(x(i.store,n,t))}},this.isMergedPreserve=function(e){var t=void 0!==e?e:i.preserve;return null==t||t},this.registerField=function(e){i.fieldEntities.push(e);var t=e.getNamePath();if(i.notifyWatch([t]),void 0!==e.props.initialValue){var n=i.store;i.resetWithFieldInitialValue({entities:[e],skipExist:!0}),i.notifyObservers(n,[e.getNamePath()],{type:"valueUpdate",source:"internal"})}return function(n,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(i.fieldEntities=i.fieldEntities.filter((function(t){return t!==e})),!i.isMergedPreserve(r)&&(!n||a.length>1)){var s=n?void 0:i.getInitialValue(t);if(t.length&&i.getFieldValue(t)!==s&&i.fieldEntities.every((function(e){return!A(e.getNamePath(),t)}))){var o=i.store;i.updateStore(x(o,t,s,!0)),i.notifyObservers(o,[t],{type:"remove"}),i.triggerDependenciesUpdate(o,t)}}i.notifyWatch([t])}},this.dispatch=function(e){switch(e.type){case"updateValue":var t=e.namePath,n=e.value;i.updateValue(t,n);break;case"validateField":var r=e.namePath,a=e.triggerName;i.validateFields([r],{triggerName:a})}},this.notifyObservers=function(e,t,r){if(i.subscribable){var a=n(n({},r),{},{store:i.getFieldsValue(!0)});i.getFieldEntities().forEach((function(n){(0,n.onStoreChange)(e,t,a)}))}else i.forceRootUpdate()},this.triggerDependenciesUpdate=function(e,n){var r=i.getDependencyChildrenFields(n);return r.length&&i.validateFields(r),i.notifyObservers(e,r,{type:"dependenciesUpdate",relatedFields:[n].concat(t(r))}),r},this.updateValue=function(e,n){var r=R(e),a=i.store;i.updateStore(x(i.store,r,n)),i.notifyObservers(a,[r],{type:"valueUpdate",source:"internal"}),i.notifyWatch([r]);var s=i.triggerDependenciesUpdate(a,r),o=i.callbacks.onValuesChange;o&&o(N(i.store,[r]),i.getFieldsValue()),i.triggerOnFieldsChange([r].concat(t(s)))},this.setFieldsValue=function(e){i.warningUnhooked();var t=i.store;if(e){var n=O(i.store,e);i.updateStore(n)}i.notifyObservers(t,null,{type:"valueUpdate",source:"external"}),i.notifyWatch()},this.setFieldValue=function(e,t){i.setFields([{name:e,value:t}])},this.getDependencyChildrenFields=function(e){var t=new Set,n=[],r=new Z;return i.getFieldEntities().forEach((function(e){(e.props.dependencies||[]).forEach((function(t){var n=R(t);r.update(n,(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Set;return t.add(e),t}))}))})),function e(i){(r.get(i)||new Set).forEach((function(r){if(!t.has(r)){t.add(r);var i=r.getNamePath();r.isFieldDirty()&&i.length&&(n.push(i),e(i))}}))}(e),n},this.triggerOnFieldsChange=function(e,t){var n=i.callbacks.onFieldsChange;if(n){var r=i.getFields();if(t){var a=new Z;t.forEach((function(e){var t=e.name,n=e.errors;a.set(t,n)})),r.forEach((function(e){e.errors=a.get(e.name)||e.errors}))}n(r.filter((function(t){var n=t.name;return M(e,n)})),r)}},this.validateFields=function(e,r){i.warningUnhooked();var a=!!e,s=a?e.map(R):[],o=[];i.getFieldEntities(!0).forEach((function(u){if(a||s.push(u.getNamePath()),(null==r?void 0:r.recursive)&&a){var l=u.getNamePath();l.every((function(t,n){return e[n]===t||void 0===e[n]}))&&s.push(l)}if(u.props.rules&&u.props.rules.length){var c=u.getNamePath();if(!a||M(s,c)){var d=u.validateRules(n({validateMessages:n(n({},P),i.validateMessages)},r));o.push(d.then((function(){return{name:c,errors:[],warnings:[]}})).catch((function(e){var n,r=[],i=[];return null===(n=e.forEach)||void 0===n||n.call(e,(function(e){var n=e.rule.warningOnly,a=e.errors;n?i.push.apply(i,t(a)):r.push.apply(r,t(a))})),r.length?Promise.reject({name:c,errors:r,warnings:i}):{name:c,errors:r,warnings:i}})))}}}));var u,l,c,d,f=(l=!1,c=(u=o).length,d=[],u.length?new Promise((function(e,t){u.forEach((function(n,r){n.catch((function(e){return l=!0,e})).then((function(n){c-=1,d[r]=n,c>0||(l&&t(d),e(d))}))}))})):Promise.resolve([]));i.lastValidatePromise=f,f.catch((function(e){return e})).then((function(e){var t=e.map((function(e){return e.name}));i.notifyObservers(i.store,t,{type:"validateFinish"}),i.triggerOnFieldsChange(t,e)}));var g=f.then((function(){return i.lastValidatePromise===f?Promise.resolve(i.getFieldsValue(s)):Promise.reject([])})).catch((function(e){var t=e.filter((function(e){return e&&e.errors.length}));return Promise.reject({values:i.getFieldsValue(s),errorFields:t,outOfDate:i.lastValidatePromise!==f})}));return g.catch((function(e){return e})),g},this.submit=function(){i.warningUnhooked(),i.validateFields().then((function(e){var t=i.callbacks.onFinish;if(t)try{t(e)}catch(n){}})).catch((function(e){var t=i.callbacks.onFinishFailed;t&&t(e)}))},this.forceRootUpdate=r}));function ne(e){var t=React.useRef(),n=React.useState({}),r=g(n,2)[1];if(!t.current)if(e)t.current=e;else{var i=new te((function(){r({})}));t.current=i.getForm()}return[t.current]}var re=React.createContext({triggerFormChange:function(){},triggerFormFinish:function(){},registerForm:function(){},unregisterForm:function(){}}),ie=function(e){var t=e.validateMessages,r=e.onFormChange,i=e.onFormFinish,s=e.children,o=React.useContext(re),u=React.useRef({});return React.createElement(re.Provider,{value:n(n({},o),{},{validateMessages:n(n({},o.validateMessages),t),triggerFormChange:function(e,t){r&&r(e,{changedFields:t,forms:u.current}),o.triggerFormChange(e,t)},triggerFormFinish:function(e,t){i&&i(e,{values:t,forms:u.current}),o.triggerFormFinish(e,t)},registerForm:function(e,t){e&&(u.current=n(n({},u.current),{},a({},e,t))),o.registerForm(e,t)},unregisterForm:function(e){var t=n({},u.current);delete t[e],u.current=t,o.unregisterForm(e)}})},s)},ae=["name","initialValues","fields","form","preserve","children","component","validateMessages","validateTrigger","onValuesChange","onFieldsChange","onFinish","onFinishFailed"];function se(e){try{return JSON.stringify(e)}catch(t){return Math.random()}}var oe=React.forwardRef((function(r,i){var a=r.name,s=r.initialValues,o=r.fields,u=r.form,l=r.preserve,c=r.children,v=r.component,h=void 0===v?"form":v,m=r.validateMessages,p=r.validateTrigger,F=void 0===p?"onChange":p,V=r.onValuesChange,E=r.onFieldsChange,k=r.onFinish,P=r.onFinishFailed,w=d(r,ae),R=React.useContext(re),C=ne(u),x=g(C,1)[0],N=x.getInternalHooks(y),M=N.useSubscribe,I=N.setInitialValues,$=N.setCallbacks,O=N.setValidateMessages,A=N.setPreserve,S=N.destroyForm;React.useImperativeHandle(i,(function(){return x})),React.useEffect((function(){return R.registerForm(a,x),function(){R.unregisterForm(a)}}),[R,x,a]),O(n(n({},R.validateMessages),m)),$({onValuesChange:V,onFieldsChange:function(e){if(R.triggerFormChange(a,e),E){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];E.apply(void 0,[e].concat(n))}},onFinish:function(e){R.triggerFormFinish(a,e),k&&k(e)},onFinishFailed:P}),A(l);var U,j=React.useRef(null);I(s,!j.current),j.current||(j.current=!0),React.useEffect((function(){return S}),[]);var T="function"==typeof c;U=T?c(x.getFieldsValue(!0),x):c,M(!T);var L=React.useRef();React.useEffect((function(){(function(n,r){if(n===r)return!0;if(!n&&r||n&&!r)return!1;if(!n||!r||"object"!==e(n)||"object"!==e(r))return!1;var i=Object.keys(n),a=Object.keys(r),s=new Set([].concat(i,a));return t(s).every((function(e){var t=n[e],i=r[e];return"function"==typeof t&&"function"==typeof i||t===i}))})(L.current||[],o||[])||x.setFields(o||[]),L.current=o}),[o,x]);var W=React.useMemo((function(){return n(n({},x),{},{validateTrigger:F})}),[x,F]),_=React.createElement(b.Provider,{value:W},U);return!1===h?_:React.createElement(h,f({},w,{onSubmit:function(e){e.preventDefault(),e.stopPropagation(),x.submit()},onReset:function(e){var t;e.preventDefault(),x.resetFields(),null===(t=w.onReset)||void 0===t||t.call(w,e)}}),_)}));oe.FormProvider=ie,oe.Field=G,oe.List=function(e){var r=e.name,i=e.initialValue,a=e.children,s=e.rules,o=e.validateTrigger,u=React.useContext(b),l=React.useRef({keys:[],id:0}).current,c=React.useMemo((function(){var e=R(u.prefixName)||[];return[].concat(t(e),t(R(r)))}),[u.prefixName,r]),d=React.useMemo((function(){return n(n({},u),{},{prefixName:c})}),[u,c]),f=React.useMemo((function(){return{getKey:function(e){var t=c.length,n=e[t];return[l.keys[n],e.slice(t+1)]}}}),[c]);return"function"!=typeof a?(v(!1,"Form.List only accepts function as children."),null):React.createElement(Y.Provider,{value:f},React.createElement(b.Provider,{value:d},React.createElement(G,{name:[],shouldUpdate:function(e,t,n){return"internal"!==n.source&&e!==t},rules:s,validateTrigger:o,initialValue:i,isList:!0},(function(e,n){var r=e.value,i=void 0===r?[]:r,s=e.onChange,o=u.getFieldValue,d=function(){return o(c||[])||[]},f={add:function(e,n){var r=d();n>=0&&n<=r.length?(l.keys=[].concat(t(l.keys.slice(0,n)),[l.id],t(l.keys.slice(n))),s([].concat(t(r.slice(0,n)),[e],t(r.slice(n))))):(l.keys=[].concat(t(l.keys),[l.id]),s([].concat(t(r),[e]))),l.id+=1},remove:function(e){var t=d(),n=new Set(Array.isArray(e)?e:[e]);n.size<=0||(l.keys=l.keys.filter((function(e,t){return!n.has(t)})),s(t.filter((function(e,t){return!n.has(t)}))))},move:function(e,t){if(e!==t){var n=d();e<0||e>=n.length||t<0||t>=n.length||(l.keys=U(l.keys,e,t),s(U(n,e,t)))}}},g=i||[];return Array.isArray(g)||(g=[]),a(g.map((function(e,t){var n=l.keys[t];return void 0===n&&(l.keys[t]=l.id,n=l.keys[t],l.id+=1),{name:t,key:n,isListField:!0}})),f,n)}))))},oe.useForm=ne,oe.useWatch=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[0],i=void 0===r?[]:r,a=t[1],s=React.useState(),o=g(s,2),u=o[0],l=o[1],c=React.useMemo((function(){return se(u)}),[u]),d=React.useRef(c);d.current=c;var f=React.useContext(b),v=a||f,h=v&&v._init,m=R(i),p=React.useRef(m);return p.current=m,React.useEffect((function(){if(h){var e=v.getFieldsValue,t=(0,(0,v.getInternalHooks)(y).registerWatch)((function(e){var t=C(e,p.current),n=se(t);d.current!==n&&(d.current=n,l(t))})),n=C(e(),p.current);return l(n),t}}),[h]),u};export{ie as F,O as s};
